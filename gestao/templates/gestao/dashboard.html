{% extends 'gestao/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Dashboard Operativa</h1>
</div>

<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-hdd-stack-fill"></i> Disponibilità PC in Magazzino
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <h5 class="card-title">Office</h5>
                        <p class="display-4">{{ disponibili_office }}</p>
                    </div>
                    <div class="col">
                        <h5 class="card-title">CAD</h5>
                        <p class="display-4">{{ disponibili_cad }}</p>
                    </div>
                    <div class="col border-start">
                        <h5 class="card-title">Totale Disponibile</h5>
                        <p class="display-4 text-success">{{ total_disponibili }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card text-center text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Preparazioni in Corso</h5>
                <p class="display-4">{{ preparazioni_in_corso }}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Dispositivi per Stato</div>
            <div class="card-body">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-calendar-event-fill text-info"></i> Prossime Preparazioni Agendate
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Preparazione</th>
                            <th>Categoria</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in prossime_preparazioni %}
                        <tr>
                            <td>{{ p.data_pianificazione|date:"d/m/Y" }}</td>
                            <td>{{ p }}</td>
                            <td>
                                {% if p.categoria == 'Priorità' %}
                                <span class="badge bg-danger">{{ p.categoria }}</span>
                                {% elif p.categoria == 'Stagista' %}
                                <span class="badge bg-info text-dark">{{ p.categoria }}</span>
                                {% elif p.categoria == 'Interinale' %}
                                <span class="badge bg-primary">{{ p.categoria }}</span>
                                {% elif p.categoria == 'Riassegnazione' or p.categoria == 'Extra' %}
                                <span class="badge bg-warning text-dark">{{ p.categoria }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ p.categoria }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3">Nessuna preparazione agendata.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-exclamation-triangle-fill text-danger"></i> 20 PC più Vecchi in Uso
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Hostname</th>
                            <th>Acquisto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pc in pcs_piu_vecchi %}
                        <tr>
                            <td>{{ pc.hostname }}</td>
                            <td>{{ pc.data_acquisto|date:"d/m/Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2">Nessun PC assegnato trovato.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}





{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // 1. Registra o plugin globalmente para o Chart.js
        Chart.register(ChartDataLabels);

        // 2. Pede os dados para a nossa NOVA API
        const response = await fetch("{% url 'disponibili_per_tipo_chart_data' %}");
        const chartData = await response.json();

        const ctx = document.getElementById('statusChart').getContext('2d');

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Numero di Dispositivi',
                    data: chartData.data,
                    backgroundColor: [ // Cores para cada fatia
                        'rgba(25, 135, 84, 0.7)',
                        'rgba(13, 110, 253, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(108, 117, 125, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom', // Legenda embaixo para dar mais espaço
                    },
                    // 3. Configuração para mostrar os números no gráfico
                    datalabels: {
                        color: '#fff', // Cor do texto
                        font: {
                            weight: 'bold',
                            size: 14,
                        },
                        // Formata o número para não mostrar '0'
                        formatter: function (value) {
                            if (value > 0) {
                                return value;
                            } else {
                                return null;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}